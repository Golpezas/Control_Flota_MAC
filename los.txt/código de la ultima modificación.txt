c√≥digo de la ultima modificaci√≥n

import React, { useEffect, useState } from 'react';
import { AxiosError } from 'axios';
import type { NewCostoInput } from '../api/models/vehiculos';
import { createCostoItem } from '../api/vehiculos';
import { apiClient } from '../api/vehiculos';  // ‚Üê IMPORT NUEVO para PUT
import { normalizePatente } from '../utils/data-utils';
import type { FastAPIErrorResponse, ValidationErrorDetail } from '../api/models/errors';

interface GastoUnificado {
    id: string;
    patente?: string;  // ‚Üê Hazlo opcional
    tipo: string;
    fecha: string;
    descripcion: string;
    importe: number;
    origen: 'mantenimiento' | 'finanzas';
    comprobante_file_id?: string;
}

interface CostoFormProps {
    initialPatente?: string;
    initialGasto?: GastoUnificado | null;  // ‚Üê NUEVO
    onSuccess: () => void;
}

const defaultFormData: NewCostoInput = {
    patente: '',
    tipo_costo: 'Reparaci√≥n Menor',
    fecha: new Date().toISOString().split('T')[0],
    descripcion: '',
    importe: 0,
    origen: 'Mantenimiento',
};

const CostoForm = ({ initialPatente, initialGasto, onSuccess }: CostoFormProps) => {
    const [formData, setFormData] = useState<NewCostoInput>(defaultFormData);
    const [isLoading, setIsLoading] = useState(false);
    const [statusMessage, setStatusMessage] = useState<string | null>(null);
    const [file, setFile] = useState<File | null>(null);

    // Prellenar en edici√≥n o con patente inicial
    useEffect(() => {
        if (initialGasto) {
            setFormData({
                patente: initialGasto.patente || normalizePatente(initialPatente || ''),
                tipo_costo: initialGasto.tipo || '',
                fecha: initialGasto.fecha.split('T')[0] || '',
                descripcion: initialGasto.descripcion || '',
                importe: initialGasto.importe || 0,
                origen: (initialGasto.origen as 'Mantenimiento' | 'Finanzas') || 'Mantenimiento'  // ‚Üê Cast seguro
            });
        } else if (initialPatente) {
            setFormData(prev => ({
                ...prev,
                patente: normalizePatente(initialPatente),
            }));
        }
    }, [initialGasto, initialPatente]);

    // Mantengo las funciones (aunque no se usen directamente, para evitar romper tu form)
    
    /*const tipoCostoOptions = [
        'Reparaci√≥n Menor', 'Reparaci√≥n Mayor', 'Neum√°ticos', 'Bater√≠a', 'Service General',
        'Multa', 'Gasto Seguro', 'Impuesto/Patente',
        'Combustible Extra', 'Otros Gastos'
    ];

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        const { name, value, type } = e.target;
        let finalValue: string | number = value;
        if (type === 'number') {
            finalValue = parseFloat(value) || 0;
        }
        setFormData(prev => ({ ...prev, [name]: finalValue }));
    };

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const selectedFile = e.target.files?.[0] || null;
        if (selectedFile && selectedFile.size > 50 * 1024 * 1024) {
            setStatusMessage('Error: Archivo demasiado grande (m√°x 50MB).');
            return;
        }
        setFile(selectedFile);
    }; */

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        setIsLoading(true);
        setStatusMessage(null);

        if (formData.importe <= 0) {
            setStatusMessage('‚ùå El importe debe ser mayor a 0.');
            setIsLoading(false);
            return;
        }

        try {
            if (initialGasto) {
                // Edici√≥n: PUT
                const formDataToSend = new FormData();
                formDataToSend.append('patente', formData.patente);
                formDataToSend.append('tipo_costo', formData.tipo_costo);
                formDataToSend.append('fecha', formData.fecha);
                formDataToSend.append('descripcion', formData.descripcion);
                formDataToSend.append('importe', formData.importe.toString());
                formDataToSend.append('origen', formData.origen);
                if (file) formDataToSend.append('comprobante', file);

                await apiClient.put(`/costos/manual/${initialGasto.id}`, formDataToSend);
            } else {
                // Creaci√≥n: tu funci√≥n original
                await createCostoItem(formData, file || null);
            }

            setStatusMessage(
                file 
                    ? `‚úÖ Costo ${initialGasto ? 'actualizado' : 'registrado'}! Comprobante subido`
                    : `‚úÖ Costo ${initialGasto ? 'actualizado' : 'registrado'} correctamente!`
            );

            setFormData(defaultFormData);
            setFile(null);
            onSuccess();
        } catch (err) {
            const error = err as AxiosError<FastAPIErrorResponse>;
            let errorMsg = 'Error desconocido al registrar el costo.';

            if (error.response) {
                const details = error.response.data?.detail;

                if (Array.isArray(details)) {
                    errorMsg = details
                        .map((d: ValidationErrorDetail) => 
                            `${d.loc.join(' ‚Üí ')}: ${d.msg} (${d.type})`
                        )
                        .join('; ');
                } else if (typeof details === 'string') {
                    errorMsg = details;
                } else if (details === undefined) {
                    errorMsg = `Error del servidor (${error.response.status})`;
                }

                errorMsg = `‚ùå ${errorMsg}`;
            } else if (error.request) {
                errorMsg = '‚ùå No se pudo conectar al servidor (verifique su conexi√≥n)';
            } else {
                errorMsg = `‚ùå ${error.message}`;
            }

            console.error('Error detallado:', error);
            setStatusMessage(errorMsg);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div style={{ padding: '20px', border: '1px solid #ccc', borderRadius: '8px', background: '#fff' }}>
            <h3 style={{ borderBottom: '1px solid #eee', paddingBottom: '10px', marginBottom: '20px', color: '#1D3557' }}>
                üí∏ {initialGasto ? 'Editar Gasto Manual' : 'Registrar Nuevo Gasto Manual'} ({formData.origen})
            </h3>
            
            {statusMessage && (
                <p style={{ 
                    padding: '10px', 
                    borderRadius: '5px', 
                    marginBottom: '15px',
                    backgroundColor: statusMessage.startsWith('‚úÖ') || statusMessage.startsWith('üìé') ? '#d4edda' : '#f8d7da',
                    color: statusMessage.startsWith('‚úÖ') || statusMessage.startsWith('üìé') ? '#155724' : '#721c24',
                    border: `1px solid ${statusMessage.startsWith('‚úÖ') || statusMessage.startsWith('üìé') ? '#c3e6cb' : '#f5c6cb'}`
                }}>
                    {statusMessage}
                </p>
            )}

            <form onSubmit={handleSubmit} style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', 
                gap: '15px' 
            }}>
                {/* Tus campos actuales (sin cambios) */}
                {/* ... todo tu form original aqu√≠ */}

                <button 
                    type="submit" 
                    disabled={isLoading} 
                    style={{ 
                        gridColumn: '1 / -1', 
                        padding: '10px 15px', 
                        marginTop: '15px', 
                        fontWeight: 'bold',
                        backgroundColor: '#E63946', 
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer'
                    }}
                >
                    {isLoading ? 'Guardando...' : initialGasto ? 'Actualizar Gasto' : 'Guardar Gasto'}
                </button>
            </form>
        </div>
    );
};

export default CostoForm;

// src/pages/VehiculoDetail.tsx

import React, { useEffect, useState, useCallback } from 'react';
import { useParams, Link } from 'react-router-dom';
import Modal from 'react-modal';
import type { 
    Vehiculo, 
    Alerta, 
    DocumentoDigital, 
} from '../api/models/vehiculos'; 
import { 
    fetchVehiculoByPatente,
    borrarGastoUniversal,
    apiClient 
} from '../api/vehiculos';
import CostoForm from '../components/CostoForm';
import axios from 'axios';
import { normalizePatente } from '../utils/data-utils';

// Interface unificada para gastos (compatible con backend actualizado)
interface GastoUnificado {
    id: string;
    patente?: string;  // ‚Üê Opcional
    tipo: string;
    fecha: string;
    descripcion: string;
    importe: number;
    origen: 'mantenimiento' | 'finanzas';
    comprobante_file_id?: string;
}

// Componente auxiliar
const DetailItem: React.FC<{ label: string; value: string | number | null | undefined }> = ({ label, value }) => (
    <div style={{ borderBottom: '1px dotted #ccc', padding: '5px 0' }}>
        <span style={{ fontWeight: 'bold', color: '#457B9D' }}>{label}:</span> {value ?? 'N/A'}
    </div>
);

const VehiculoDetail: React.FC = () => {
    const { patente } = useParams<{ patente: string }>();
    const [vehiculo, setVehiculo] = useState<Vehiculo | null>(null);
    const [gastosUnificados, setGastosUnificados] = useState<GastoUnificado[]>([]);
    const [totalGeneral, setTotalGeneral] = useState(0);
    const [totalMantenimiento, setTotalMantenimiento] = useState(0);
    const [totalMultas, setTotalMultas] = useState(0);
    const [alertas, setAlertas] = useState<Alerta[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    // Estados para modal de documentos
    const [modalIsOpen, setModalIsOpen] = useState(false);
    const [docSeleccionado, setDocSeleccionado] = useState<DocumentoDigital | null>(null);
    const [previewUrl, setPreviewUrl] = useState<string | null>(null);
    const [loadingPreview, setLoadingPreview] = useState(false);
    const [archivoNuevo, setArchivoNuevo] = useState<File | null>(null);

    const [modalComprobanteOpen, setModalComprobanteOpen] = useState(false);
    const [comprobantePreviewUrl, setComprobantePreviewUrl] = useState<string | null>(null);
    const [comprobanteLoading, setComprobanteLoading] = useState(false);

    const [vencimientos, setVencimientos] = useState<{ tipo: string, fecha_vencimiento: string }[]>([]);
    const [editingVencimiento, setEditingVencimiento] = useState<string | null>(null);
    const [newFecha, setNewFecha] = useState('');

    const [editingGasto, setEditingGasto] = useState<GastoUnificado | null>(null);
    
    const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';

    // =========================================
    // FUNCIONES PARA DOCUMENTOS DIGITALES (tu c√≥digo original, perfecto)
    // =========================================

    const abrirComprobante = async (fileId: string) => {
        setComprobantePreviewUrl(null);
        setComprobanteLoading(true);
        setModalComprobanteOpen(true);

        try {
            const timestamp = Date.now();
            const url = `${API_URL}/api/archivos/descargar/${fileId}?preview=true&t=${timestamp}`;

            // Siempre usamos blob (como en im√°genes de documentos digitales)
            // Esto funciona perfecto para PNG, JPG y PDF
            const response = await fetch(url, { cache: "no-store" });
            if (!response.ok) {
                throw new Error(`Error al cargar (HTTP ${response.status})`);
            }
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            setComprobantePreviewUrl(blobUrl);

        } catch (err) {
            console.error("Error cargando comprobante:", err);
            alert("Error al cargar el comprobante. Intent√° refrescar la p√°gina.");
        } finally {
            setComprobanteLoading(false);
        }
    };

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            setArchivoNuevo(e.target.files[0]);
        }
    };

    const handleDownload = (fileId: string) => {
        window.open(`${API_URL}/api/archivos/descargar/${fileId}`, '_blank');
    };

    const abrirModalDocumento = async (doc: DocumentoDigital) => {
        setDocSeleccionado(doc);
        setPreviewUrl(null);
        setLoadingPreview(true);
        setArchivoNuevo(null);

        if (!doc.file_id) {
            setLoadingPreview(false);
            setModalIsOpen(true);
            return;
        }

        try {
            const timestamp = Date.now();
            const url = `${API_URL}/api/archivos/descargar/${doc.file_id}?preview=true&t=${timestamp}`;

            if (doc.nombre_archivo?.toLowerCase().includes(".pdf")) {
                setPreviewUrl(url);
            } else {
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error("No se pudo cargar");
                const blob = await response.blob();
                setPreviewUrl(URL.createObjectURL(blob));
            }
        } catch (err) {
            console.error("Error cargando vista previa:", err);
            alert("Error al cargar el documento. Reintent√° en 10 segundos.");
        } finally {
            setLoadingPreview(false);
        }

        setModalIsOpen(true);
    };

    const subirDocumento = async () => {
        if (!docSeleccionado || !archivoNuevo || !vehiculo) {
            alert("Faltan datos: selecciona documento y archivo.");
            return;
        }

        const formData = new FormData();
        formData.append("patente", normalizePatente(vehiculo._id));
        formData.append("tipo", docSeleccionado.tipo);
        formData.append("file", archivoNuevo);

        try {
            // FORZAMOS EL HEADER CORRECTO (esto es clave)
            const response = await apiClient.post("/api/archivos/subir-documento", formData, {
                headers: {
                    "Content-Type": "multipart/form-data",  // ‚Üê FORZAMOS (Axios a veces lo pierde)
                },
                timeout: 60000,
            });

            console.log("Subida exitosa:", response.data);
            alert(`‚úÖ Documento "${docSeleccionado.tipo.replace(/_/g, " ")}" subido correctamente`);

            setModalIsOpen(false);
            setArchivoNuevo(null);
            await cargarDatos();  // Refresca la lista de documentos

        } catch (error: unknown) {
            console.error("Error subiendo documento:", error);

            let msg = "Error al subir el documento.";
            if (axios.isAxiosError(error) && error.response) {
                msg += ` (Status: ${error.response.status})`;
                if (error.response.data?.detail) {
                    msg += ` - ${JSON.stringify(error.response.data.detail)}`;
                }
            }
            alert(`‚ùå ${msg} Reintent√° o verifica el archivo.`);
        }
    };

    // =========================================
    // FUNCIONES PARA EDITAR GASTOS
    // =========================================
    
    const editarGasto = (gasto: GastoUnificado) => {
        setEditingGasto(gasto);
        // Opcional: scroll al formulario
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    // =========================================
    // CARGA DE DATOS
    // =========================================

    const cargarDatos = useCallback(async () => {
        if (!patente) return;

        setLoading(true);
        setError(null);

        try {
            // 1. Veh√≠culo
            const vehData = await fetchVehiculoByPatente(patente);
            setVehiculo(vehData);

            // 2. Vencimientos: ahora usamos vehData (la respuesta fresca) en lugar de vehiculo (estado viejo)
            const vencimientosData = (vehData.documentos_digitales || []).map(doc => ({
                tipo: doc.tipo,
                fecha_vencimiento: doc.fecha_vencimiento 
                    ? new Date(doc.fecha_vencimiento).toLocaleDateString('es-AR') 
                    : 'Sin fecha'
            }));
            setVencimientos(vencimientosData);

            // 3. Alertas
            const report = await apiClient.get(
                `/vehiculos/${patente}/reporte?start_date=2023-01-01&end_date=${new Date().toISOString().split('T')[0]}`
            );
            setAlertas(report.data.alertas || []);

            // 4. Gastos unificados
            const response = await apiClient.get(`/costos/unificado/${patente}`);
            console.log('DEBUG GASTOS UNIFICADOS:', response.data);

            const data = response.data;
            setGastosUnificados(data.gastos || []);
            setTotalGeneral(data.total_general || 0);
            setTotalMantenimiento(data.total_mantenimiento || 0);
            setTotalMultas(data.total_multas || 0);

        } catch (error: unknown) {
            console.error("Error en cargarDatos:", error);
            let mensaje = 'Error al cargar los datos del veh√≠culo.';
            
            if (error instanceof Error) {
                mensaje += ` ${error.message}`;
            }
            
            setError(mensaje);
        } finally {
            setLoading(false);
        }
    }, [patente]);

    useEffect(() => {
        cargarDatos();
    }, [cargarDatos]);

    // Correcci√≥n del error de tipos: origen debe coincidir con la funci√≥n
    const handleBorrarGasto = async (id: string, origen: 'mantenimiento' | 'finanzas') => {
        try {
            // La funci√≥n espera "costos" para mantenimiento y "finanzas" para multas
            const coleccion = origen === 'mantenimiento' ? 'costos' : 'finanzas';
            await borrarGastoUniversal(id, coleccion);
            await cargarDatos();
        } catch (err: unknown) {
            console.error('Error borrando gasto:', err);
            alert("Error al borrar el gasto");
        }
    };

    if (loading) return <div>Cargando datos del veh√≠culo... ‚è≥</div>;
    if (error) return <div style={{ color: 'red' }}>‚ùå {error}</div>;
    if (!vehiculo) return <div>No se encontr√≥ el veh√≠culo.</div>;

    return (
        <div style={{ padding: '30px', maxWidth: '900px', margin: '0 auto', backgroundColor: '#f8fafc', color: '#1e293b' }}>
            <h1 style={{ borderBottom: '2px solid #ccc', paddingBottom: '10px', marginBottom: '20px', color: '#1D3557' }}>
                Detalle del Veh√≠culo: {vehiculo._id}
            </h1>

            {/* INFORMACI√ìN B√ÅSICA */}
            <div style={{ marginBottom: '30px' }}>
                <h2 style={{ color: '#457B9D' }}>Informaci√≥n B√°sica</h2>
                {/*<DetailItem label="Patente Original" value={vehiculo.patente_original} />*/}
                <DetailItem label="N¬∫ M√≥vil" value={vehiculo.nro_movil} />
                <DetailItem label="Modelo" value={vehiculo.descripcion_modelo} />
                <DetailItem label="A√±o" value={vehiculo.anio} />
                <DetailItem label="Color" value={vehiculo.color} />
                <DetailItem label="Combustible" value={vehiculo.tipo_combustible} />
                <DetailItem label="Activo" value={vehiculo.activo ? 'S√≠' : 'No'} />
            </div>

            {/* DOCUMENTOS DIGITALES (tu c√≥digo original completo) */}
            <div style={{ backgroundColor: '#f8fafc', padding: '24px', borderRadius: '12px', border: '1px solid #e2e8f0', marginTop: '32px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' }}>
                <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1e293b', marginBottom: '20px' }}>Documentos Digitales</h2>
                {vehiculo?.documentos_digitales == null || vehiculo.documentos_digitales.length === 0 ? (
                    <p style={{ color: '#475569', fontStyle: 'italic' }}>No hay documentos configurados para este veh√≠culo.</p>
                ) : (
                    vehiculo.documentos_digitales.map((doc, index) => {
                        const tieneArchivo = !!doc.file_id;
                        return (
                            <div key={index} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 0', borderBottom: '1px solid #e2e8f0' }}>
                                <strong style={{ color: '#1e293b' }}>
                                    {doc.tipo.replace(/_/g, " ").toUpperCase()}:
                                </strong>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                    <span style={{
                                        fontWeight: 'bold',
                                        fontSize: '0.875rem',
                                        padding: '4px 12px',
                                        borderRadius: '9999px',
                                        backgroundColor: tieneArchivo ? '#d1fae5' : '#fee2e2',
                                        color: tieneArchivo ? '#059669' : '#ef4444',
                                    }}>
                                        {tieneArchivo ? "Subido" : "Falta"}
                                    </span>
                                    {tieneArchivo && (
                                        <button onClick={() => handleDownload(doc.file_id!)} style={{ padding: '8px 16px', backgroundColor: '#2563eb', color: 'white', borderRadius: '8px' }}>
                                            Descargar {doc.nombre_archivo ? `(${doc.nombre_archivo})` : ""}
                                        </button>
                                    )}
                                    <button onClick={() => abrirModalDocumento(doc)} style={{
                                        padding: '8px 16px',
                                        backgroundColor: tieneArchivo ? '#d97706' : '#dc2626',
                                        color: 'white',
                                        borderRadius: '8px'
                                    }}>
                                        {tieneArchivo ? "Revisar / Reemplazar" : "Subir"}
                                    </button>
                                </div>
                            </div>
                        );
                    })
                )}
            </div>

            {/* MODAL PARA SUBIR / REVISAR DOCUMENTO */}
            <Modal
                isOpen={modalIsOpen}
                onRequestClose={() => {
                    setModalIsOpen(false);
                    if (previewUrl && previewUrl.startsWith("blob:")) URL.revokeObjectURL(previewUrl);
                    setPreviewUrl(null);
                }}
                style={{
                    content: {
                        backgroundColor: 'white',
                        color: 'black',
                        maxWidth: '80%',
                        maxHeight: '80%',
                        top: '50%',
                        left: '50%',
                        right: 'auto',
                        bottom: 'auto',
                        marginRight: '-50%',
                        transform: 'translate(-50%, -50%)',
                        padding: '32px',
                        borderRadius: '16px',
                        boxShadow: '0 10px 25px rgba(0,0,0,0.2)',
                        overflowY: 'auto'
                    }
                }}
                ariaHideApp={false}
            >
                <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1e293b', marginBottom: '24px', textAlign: 'center' }}>
                    {docSeleccionado?.tipo.replace(/_/g, " ").toUpperCase() || "Documento"}
                </h2>

                {loadingPreview ? (
                    <div style={{ textAlign: 'center', padding: '80px 0' }}>
                        <div className="spinner-documento"></div>
                        <p style={{ color: '#475569', fontSize: '1.125rem', marginTop: '16px' }}>Cargando documento...</p>
                        <p style={{ color: '#64748b', fontSize: '0.875rem' }}>Puede tardar unos segundos (Render Free)</p>
                    </div>
                ) : previewUrl ? (
                    docSeleccionado?.nombre_archivo?.toLowerCase().includes(".pdf") ? (
                        <iframe
                            src={previewUrl}
                            style={{ width: '100%', height: '500px', border: '1px solid #e2e8f0', borderRadius: '12px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' }}
                            title="Vista previa PDF"
                        />
                    ) : (
                        <img
                            src={previewUrl}
                            alt="Vista previa"
                            style={{ maxWidth: '100%', height: 'auto', borderRadius: '12px', border: '1px solid #e2e8f0', boxShadow: '0 4px 6px rgba(0,0,0,0.1)', margin: '0 auto', display: 'block' }}
                        />
                    )
                ) : (
                    <div style={{ textAlign: 'center', padding: '80px 0' }}>
                        <p style={{ color: '#ef4444', fontSize: '1.125rem', fontWeight: 'medium' }}>No se pudo cargar el documento</p>
                        <p style={{ color: '#475569', marginTop: '12px' }}>Intent√° de nuevo en 10 segundos</p>
                    </div>
                )}

                <div style={{ marginTop: '32px' }}>
                    <input
                        type="file"
                        accept=".pdf,.jpg,.jpeg,.png"
                        onChange={handleFileChange}
                        style={{ display: 'block', width: '100%', fontSize: '0.875rem', color: '#475569' }}
                        className="file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-bold file:bg-emerald-600 file:text-white hover:file:bg-emerald-700 cursor-pointer"
                    />
                </div>

                <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '16px', marginTop: '40px' }}>
                    <button
                        onClick={() => {
                            setModalIsOpen(false);
                            if (previewUrl && previewUrl.startsWith("blob:")) URL.revokeObjectURL(previewUrl);
                            setPreviewUrl(null);
                        }}
                        style={{ padding: '12px 24px', backgroundColor: '#64748b', color: 'white', borderRadius: '12px', cursor: 'pointer', transition: 'background-color 0.3s', fontWeight: 'bold' }}
                        onMouseOver={(e) => (e.currentTarget.style.backgroundColor = '#475569')}
                        onMouseOut={(e) => (e.currentTarget.style.backgroundColor = '#64748b')}
                    >
                        Cancelar
                    </button>
                    <button
                        onClick={subirDocumento}
                        disabled={!archivoNuevo}
                        style={{
                            padding: '12px 32px',
                            borderRadius: '12px',
                            fontWeight: 'bold',
                            transition: 'background-color 0.3s',
                            backgroundColor: archivoNuevo ? '#059669' : '#d1d5db',
                            color: archivoNuevo ? 'white' : '#9ca3af',
                            cursor: archivoNuevo ? 'pointer' : 'not-allowed',
                        }}
                        onMouseOver={(e) => archivoNuevo && (e.currentTarget.style.backgroundColor = '#047857')}
                        onMouseOut={(e) => archivoNuevo && (e.currentTarget.style.backgroundColor = '#059669')}
                    >
                        {docSeleccionado?.file_id ? "Reemplazar Documento" : "Subir Documento"}
                    </button>
                </div>
            </Modal>

            {/* VENCIMIENTOS DE DOCUMENTOS */}
            <div style={{ backgroundColor: '#f8fafc', padding: '24px', borderRadius: '12px', border: '1px solid #e2e8f0', marginTop: '32px', boxShadow: '0 4px 6px rgba(0,0,0,0.1)' }}>
                <h2 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1e293b', marginBottom: '20px' }}>Vencimientos de Documentos</h2>
                {vencimientos.length > 0 ? (
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead style={{ backgroundColor: '#1D3557', color: 'white' }}>
                            <tr>
                                <th style={{ padding: '15px', textAlign: 'left' }}>Documento</th>
                                <th style={{ padding: '15px', textAlign: 'left' }}>Fecha Vencimiento</th>
                                <th style={{ padding: '15px', textAlign: 'center' }}>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {vencimientos.map((ven, index) => (
                                <tr key={index} style={{ borderBottom: '1px solid #e2e8f0' }}>
                                    <td style={{ padding: '15px' }}>{ven.tipo.replace(/_/g, ' ')}</td>
                                    <td style={{ padding: '15px' }}>{ven.fecha_vencimiento}</td>
                                    <td style={{ padding: '15px', textAlign: 'center' }}>
                                        <button onClick={() => setEditingVencimiento(ven.tipo)} style={{ background: '#f59e0b', color: 'white', padding: '8px 16px', border: 'none', borderRadius: '8px' }}>
                                            Editar Fecha
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                ) : (
                    <p>No hay vencimientos configurados.</p>
                )}

                {editingVencimiento && (
                    <div style={{ marginTop: '20px', padding: '20px', background: '#fff', borderRadius: '12px', boxShadow: '0 4px 8px rgba(0,0,0,0.1)' }}>
                        <h3>Editar Vencimiento de {editingVencimiento.replace(/_/g, ' ')}</h3>
                        <input 
                            type="date" 
                            value={newFecha}
                            onChange={(e) => setNewFecha(e.target.value)}
                            style={{ padding: '10px', marginBottom: '10px' }}
                        />
                        <button 
                            onClick={async () => {
                                try {
                                    await apiClient.put(`/vencimientos/${patente}/${editingVencimiento}`, { 
                                        fecha_vencimiento: new Date(newFecha).toISOString()
                                    });
                                    await cargarDatos();
                                    setEditingVencimiento(null);
                                    setNewFecha('');
                                    alert("Fecha actualizada correctamente");
                                } catch {
                                    alert("Error al actualizar la fecha de vencimiento");
                                }
                            }} 
                            style={{ background: '#059669', color: 'white', padding: '10px 20px', border: 'none', borderRadius: '8px', cursor: 'pointer' }}
                        >
                            Guardar
                        </button>
                        <button onClick={() => setEditingVencimiento(null)} style={{ marginLeft: '10px', background: '#64748b', color: 'white', padding: '10px 20px', border: 'none', borderRadius: '8px' }}>
                            Cancelar
                        </button>
                    </div>
                )}
            </div>

            {/* ALERTAS DE VENCIMIENTO CR√çTICAS */}
            <div style={{ marginBottom: '40px' }}>
                <h2 style={{ 
                    color: alertas.length > 0 ? '#E63946' : '#2d6a4f', 
                    fontSize: '1.6rem', 
                    fontWeight: 'bold',
                    marginBottom: '20px'
                }}>
                    Alertas de Vencimiento Cr√≠ticas ({alertas.length})
                </h2>

                {alertas.length > 0 ? (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        {alertas.map((alerta, index) => (
                            <div 
                                key={index}
                                style={{
                                    padding: '18px',
                                    backgroundColor: '#fff5f5',
                                    border: `3px solid ${alerta.mensaje.includes('VENCIDO') || alerta.mensaje.includes('HOY') ? '#E63946' : '#f59e0b'}`,
                                    borderRadius: '12px',
                                    boxShadow: '0 6px 12px rgba(230,57,70,0.15)'
                                }}
                            >
                                <div style={{ fontSize: '1.3em', fontWeight: 'bold', color: '#E63946', marginBottom: '10px' }}>
                                    üö® {alerta.mensaje}
                                </div>
                                <div style={{ color: '#1e293b', lineHeight: '1.6' }}>
                                    <strong>Patente:</strong> <strong>{alerta.patente}</strong><br />
                                    <strong>M√≥vil:</strong> {alerta.movil_nro || 'N/A'} - {alerta.descripcion_modelo || 'Sin modelo'}<br />
                                    <strong>Vencimiento:</strong> {new Date(alerta.fecha_vencimiento).toLocaleDateString('es-AR')}
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div style={{ 
                        padding: '20px', 
                        backgroundColor: '#f0fdf4', 
                        border: '2px solid #22c55e', 
                        borderRadius: '12px',
                        color: '#166534',
                        fontWeight: 'bold',
                        fontSize: '1.1em'
                    }}>
                        ‚úÖ No hay alertas cr√≠ticas de vencimiento.
                    </div>
                )}
            </div>

            {/* TOTALES DE COSTOS */}
            <div style={{ marginBottom: '30px' }}>
                <h2 style={{ color: '#457B9D', fontSize: '1.5rem', fontWeight: 'bold' }}>
                    Reporte de Costos (Todos los registros)
                </h2>
                <p><strong>Total General:</strong> ${totalGeneral.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</p>
                <p><strong>Mantenimiento:</strong> ${totalMantenimiento.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</p>
                <p><strong>Infracciones:</strong> ${totalMultas.toLocaleString('es-AR', { minimumFractionDigits: 2 })}</p>
            </div>

            {/* HISTORIAL DE COSTOS */}
            <div style={{ border: '1px solid #ddd', borderRadius: '8px', overflow: 'hidden', backgroundColor: 'white' }}>
                <h2 style={{ padding: '15px', backgroundColor: '#1D3557', color: 'white' }}>
                    Historial de Costos ({gastosUnificados.length})
                </h2>
                {gastosUnificados.length > 0 ? (
                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                        <thead style={{ backgroundColor: '#f8f9fa' }}>
                            <tr>
                                <th style={{ padding: '12px', textAlign: 'left' }}>Fecha</th>
                                <th style={{ padding: '12px', textAlign: 'left' }}>Tipo</th>
                                <th style={{ padding: '12px', textAlign: 'left' }}>Descripci√≥n</th>
                                <th style={{ padding: '12px', textAlign: 'right' }}>Importe</th>
                                <th style={{ padding: '12px', textAlign: 'center' }}>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {gastosUnificados.map((gasto) => (
                                <tr key={gasto.id} style={{ borderBottom: '1px solid #eee' }}>
                                    <td style={{ padding: '12px' }}>{gasto.fecha.split('T')[0]}</td>
                                    <td style={{ padding: '12px' }}>
                                        <span style={{ 
                                            padding: '4px 8px', 
                                            borderRadius: '12px', 
                                            backgroundColor: gasto.tipo.toLowerCase().includes('multa') ? '#fee' : '#e6f4ea',
                                            color: gasto.tipo.toLowerCase().includes('multa') ? '#c1121f' : '#2d6a4f',
                                            fontWeight: 'bold'
                                        }}>
                                            {gasto.tipo}
                                        </span>
                                    </td>
                                    <td style={{ padding: '12px' }}>
                                        {gasto.descripcion}
                                        {gasto.comprobante_file_id && (
                                            <button 
                                                onClick={() => abrirComprobante(gasto.comprobante_file_id!)}
                                                style={{ marginLeft: '10px', fontSize: '0.8em', color: '#2563eb', background: 'none', border: 'none', cursor: 'pointer', textDecoration: 'underline' }}
                                            >
                                                üëÅÔ∏è Ver comprobante
                                            </button>
                                        )}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'right', fontWeight: 'bold' }}>
                                        ${gasto.importe.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                                    </td>
                                    <td style={{ padding: '12px', textAlign: 'center' }}>
                                        <button 
                                            onClick={() => editarGasto(gasto)}
                                            style={{ 
                                                background: '#f59e0b', 
                                                color: 'white', 
                                                padding: '8px 16px', 
                                                border: 'none', 
                                                borderRadius: '8px', 
                                                cursor: 'pointer', 
                                                marginRight: '10px'
                                            }}
                                        >
                                            Editar
                                        </button>
                                        <button 
                                            onClick={() => handleBorrarGasto(gasto.id, gasto.origen)}
                                            style={{ background: '#dc3545', color: 'white', border: 'none', padding: '8px 16px', borderRadius: '8px', cursor: 'pointer' }}
                                        >
                                            Borrar
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                ) : (
                    <div style={{ padding: '20px', textAlign: 'center' }}>No hay costos registrados.</div>
                )}
            </div>

            {/* SECCI√ìN PARA AGREGAR O EDITAR COSTO */}
            <div style={{ marginTop: '30px' }}>
                <h2 style={{ color: '#457B9D' }}>
                    {editingGasto ? 'Editar Costo' : 'Agregar Nuevo Costo'}
                </h2>
                <CostoForm 
                    initialPatente={patente || ''}
                    initialGasto={editingGasto}
                    onSuccess={() => {
                        cargarDatos();
                        setEditingGasto(null);
                    }}
                />
            </div>

            <Link to="/vehiculos" style={{ display: 'block', marginTop: '30px', color: '#457B9D', textDecoration: 'none', fontWeight: 'bold' }}>
                ‚Üê Volver al Listado de Veh√≠culos
            </Link>

            {/* MODAL PARA VER COMPROBANTE DE COSTO */}
            <Modal
                isOpen={modalComprobanteOpen}
                onRequestClose={() => {
                    setModalComprobanteOpen(false);
                    if (comprobantePreviewUrl && comprobantePreviewUrl.startsWith("blob:")) {
                        URL.revokeObjectURL(comprobantePreviewUrl);
                    }
                    setComprobantePreviewUrl(null);
                }}
                style={{
                    content: {
                        top: '50%',
                        left: '50%',
                        right: 'auto',
                        bottom: 'auto',
                        marginRight: '-50%',
                        transform: 'translate(-50%, -50%)',
                        width: '90%',
                        maxWidth: '1000px',
                        height: '90%',
                        padding: '20px',
                        borderRadius: '16px',
                        boxShadow: '0 10px 30px rgba(0,0,0,0.3)'
                    }
                }}
                ariaHideApp={false}
            >
                <h2 style={{ textAlign: 'center', marginBottom: '20px', color: '#1D3557' }}>
                    Comprobante del Costo
                </h2>

                {comprobanteLoading ? (
                    <div style={{ textAlign: 'center', padding: '100px 0' }}>
                        <p>Cargando comprobante...</p>
                        <p style={{ fontSize: '0.9em', color: '#666' }}>Puede tardar unos segundos</p>
                    </div>
                ) : comprobantePreviewUrl ? (
                    <div style={{ width: '100%', height: 'calc(100% - 80px)', display: 'flex', justifyContent: 'center', alignItems: 'center', background: '#f8fafc' }}>
                        <img 
                            src={comprobantePreviewUrl}
                            alt="Comprobante del costo"
                            style={{
                                maxWidth: '100%',
                                maxHeight: '100%',
                                objectFit: 'contain',
                                borderRadius: '8px',
                                boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                            }}
                        />
                    </div>
                ) : (
                    <div style={{ textAlign: 'center', padding: '100px 0', color: '#e74c3c' }}>
                        <p>No se pudo cargar el comprobante</p>
                    </div>
                )}

                <div style={{ textAlign: 'center', marginTop: '20px' }}>
                    <button
                        onClick={() => {
                            setModalComprobanteOpen(false);
                            if (comprobantePreviewUrl && comprobantePreviewUrl.startsWith("blob:")) {
                                URL.revokeObjectURL(comprobantePreviewUrl);
                            }
                            setComprobantePreviewUrl(null);
                        }}
                        style={{ padding: '10px 20px', background: '#64748b', color: 'white', borderRadius: '8px' }}
                    >
                        Cerrar
                    </button>
                </div>
            </Modal>    

        </div>
    );
};

export default VehiculoDetail;

# routers/costos.py ‚Üí VERSI√ìN CORREGIDA Y DEFINITIVA (2025-12-13)
# Eliminamos inicializaci√≥n top-level de fs ‚Üí usamos funci√≥n lazy async

import re  # ‚Üê Para validaci√≥n de patr√≥n en origen
from dateutil.parser import parse, ParserError
from datetime import datetime
from fastapi import APIRouter, Query, HTTPException, Form, UploadFile, File
from typing import Optional
from dependencies import normalize_patente, get_db_collection, _client, DB_NAME, CostoManualInput,get_gridfs_bucket
from bson import ObjectId
import logging
from motor.motor_asyncio import AsyncIOMotorGridFSBucket
from pydantic import BaseModel

logger = logging.getLogger(__name__)
router = APIRouter(prefix="/costos", tags=["Costos"])

# =================================================================
# MODELO DE RESPUESTA
# =================================================================
class CreateCostoResponse(BaseModel):
    message: str
    costo_id: str
    file_id: str | None = None

    model_config = {"extra": "ignore"}

def normalize_patente(patente: str) -> str:
    if not patente:
        return ""
    return patente.strip().upper().replace(" ", "").replace("-", "")

def safe_parse_date(fecha_raw) -> datetime:
    """Parsea fechas con tolerancia extrema a formatos legacy"""
    if isinstance(fecha_raw, datetime):
        return fecha_raw
    if not isinstance(fecha_raw, str) or fecha_raw in ("N/A", "", "0001-01-01T00:00:00"):
        return datetime(1970, 1, 1)  # Fecha neutra para ordenar al final
    try:
        return datetime.fromisoformat(fecha_raw.replace("Z", "+00:00"))
    except:
        try:
            return datetime.strptime(fecha_raw, '%Y-%m-%dT%H:%M:%S')
        except:
            return datetime(1970, 1, 1)

@router.get("/unificado/{patente}")
async def get_gastos_unificados(patente: str):
    patente_norm = normalize_patente(patente)
    logger.info(f"Reporte unificado solicitado para: {patente_norm}")

    try:
        mant_collection = get_db_collection("Mantenimiento")
        fin_collection = get_db_collection("Finanzas")
    except Exception as e:
        logger.error(f"Error conectando colecciones: {e}")
        raise HTTPException(500, "Error de base de datos")

    todos = []

    # ==================== PROCESAR COLECCI√ìN MANTENIMIENTO ====================
    async for doc in mant_collection.find({"patente": patente_norm}).sort("fecha", -1):
        try:
            # Campos NUEVOS (costos manuales modernos)
            if "importe" in doc or "tipo_costo" in doc:
                fecha = doc.get("fecha")
                if isinstance(fecha, str):
                    fecha = safe_parse_date(fecha)
                fecha_str = fecha.isoformat() if hasattr(fecha, "isoformat") else str(fecha)

                tipo = doc.get("tipo_costo", "Mantenimiento General")
                monto = float(doc.get("importe", 0) or 0)
                descripcion = doc.get("descripcion", "Sin descripci√≥n").strip()
                origen = "mantenimiento"

            # Campos ANTIGUOS (legado)
            else:
                fecha_str = safe_parse_date(doc.get("fecha", "1970-01-01")).isoformat()
                tipo = (doc.get("motivo") or doc.get("tipo_registro") or "Mantenimiento General").strip()
                monto_raw = doc.get("costo_monto") or doc.get("COSTO_MONTO") or 0
                monto = float(monto_raw) if monto_raw else 0.0
                descripcion = (doc.get("descripcion") or doc.get("DESCRIPCIN") or "").strip()
                origen = "mantenimiento"

            if monto <= 0:
                continue
            if any(palabra in descripcion.lower() for palabra in ["administrativo", "correccion", "ajuste", "devolucion"]):
                continue

            todos.append({
                "id": str(doc["_id"]),
                "fecha": fecha_str,
                "tipo": tipo,                   # ‚Üê Este es el que muestra en la columna "Tipo"
                "descripcion": descripcion,
                "importe": monto,               # ‚Üê Cambi√© "monto" por "importe" para coincidir con frontend
                "origen": origen,
                "comprobante_file_id": doc.get("comprobante_file_id")
            })
        except Exception as e:
            logger.warning(f"Error procesando doc mantenimiento {doc.get('_id')}: {e}")
            continue

    # ==================== PROCESAR COLECCI√ìN FINANZAS ====================
    async for doc in fin_collection.find({"patente": patente_norm}).sort("fecha", -1):
        try:
            # Campos NUEVOS (multas manuales)
            if "importe" in doc or "tipo_costo" in doc:
                fecha = doc.get("fecha")
                if isinstance(fecha, str):
                    fecha = safe_parse_date(fecha)
                fecha_str = fecha.isoformat() if hasattr(fecha, "isoformat") else str(fecha)

                tipo = doc.get("tipo_costo", "Multa")
                monto = float(doc.get("importe", 0) or 0)
                descripcion = doc.get("descripcion", "Multa").strip()
                origen = "finanzas"

            # Campos ANTIGUOS
            else:
                fecha_raw = doc.get("dia") or doc.get("FECHA_INFRACCION") or doc.get("fecha_infraccion") or "1970-01-01"
                fecha_str = safe_parse_date(fecha_raw).isoformat()
                tipo = doc.get("tipo_registro", "Multa").strip()
                monto = float(doc.get("monto") or doc.get("MONTO") or 0)
                descripcion = (doc.get("motivo") or doc.get("MOTIVO") or "Sin descripci√≥n").strip()
                origen = "finanzas"

            if monto <= 0:
                continue
            if any(palabra in descripcion.lower() for palabra in ["administrativo", "correccion", "devolucion", "descuento", "ajuste"]):
                continue

            todos.append({
                "id": str(doc["_id"]),
                "fecha": fecha_str,
                "tipo": tipo,
                "descripcion": descripcion,
                "importe": monto,
                "origen": origen,
                "comprobante_file_id": doc.get("comprobante_file_id")
            })
        except Exception as e:
            logger.warning(f"Error procesando doc finanzas {doc.get('_id')}: {e}")
            continue

    # ==================== C√ÅLCULOS FINALES ====================
    total_general = sum(g["importe"] for g in todos)
    total_mantenimiento = sum(g["importe"] for g in todos if g["origen"] == "mantenimiento")
    total_multas = sum(g["importe"] for g in todos if "multa" in g["tipo"].lower() or g["tipo"] in ["Multa", "INFRACCION"])

    respuesta = {
        "patente": patente_norm,
        "gastos": todos,  # ‚Üê Lista unificada con formato consistente
        "total_general": round(total_general, 2),
        "total_mantenimiento": round(total_mantenimiento, 2),
        "total_multas": round(total_multas, 2),
        "total_otras": round(total_general - total_mantenimiento - total_multas, 2)
    }

    logger.info(f"Reporte exitoso {patente_norm}: {len(todos)} items | Total: ${total_general:,.2f}")
    return respuesta

# =================================================================
# ENDPOINT: CREAR COSTO MANUAL (actualizado para usar get_gridfs_bucket)
# =================================================================
# === RUTA PARA JSON (sin comprobante) ===
@router.post("/manual/json")
async def crear_costo_manual_json(data: CostoManualInput):
    logger.info(f"Creando costo manual JSON para patente: {data.patente}")  # ‚Üê Agregar logging para trazabilidad
    normalized_patente = normalize_patente(data.patente)
    
    costo_dict = data.model_dump()
    costo_dict["patente"] = normalized_patente
    costo_dict["comprobante_file_id"] = None
    costo_dict["fecha"] = data.fecha if isinstance(data.fecha, datetime) else datetime.combine(data.fecha, datetime.min.time())  # ‚Üê Asegurar datetime si es date
    
    collection = get_db_collection("Mantenimiento" if data.origen == "Mantenimiento" else "Finanzas")
    result = await collection.insert_one(costo_dict)
    
    logger.info(f"Costo creado: ID {result.inserted_id}")  # ‚Üê Logging √©xito
    return CreateCostoResponse(
        message="Costo registrado correctamente",
        costo_id=str(result.inserted_id),
        file_id=None
    )

# === RUTA EXISTENTE PARA MULTIPART (con comprobante) ===
@router.post("/manual")
async def crear_costo_manual(
    patente: str = Form(...),
    tipo_costo: str = Form(...),
    fecha: str = Form(...),
    descripcion: str = Form(...),
    importe: float = Form(...),
    origen: str = Form(...),
    comprobante: Optional[UploadFile] = File(None)
):
    """
    Registra costo manual con comprobante opcional (multipart/form-data).
    Validaci√≥n estricta equivalente a CostoManualInput (Pydantic).
    """
    logger.info(f"Creando costo multipart - Patente: {patente}, Archivo: {comprobante.filename if comprobante else 'None'}")

    # === VALIDACI√ìN MANUAL ESTRICTA (mirror de CostoManualInput) ===
    # 1. Importe > 0 y redondeo
    if importe <= 0:
        logger.warning(f"Importe inv√°lido: {importe}")
        raise HTTPException(status_code=422, detail="Importe debe ser mayor a 0.")
    importe = round(importe, 2)

    # 2. Origen v√°lido
    if not re.match(r"^(Finanzas|Mantenimiento)$", origen):
        logger.warning(f"Origen inv√°lido: {origen}")
        raise HTTPException(status_code=422, detail="Origen debe ser 'Finanzas' o 'Mantenimiento'.")

    # 3. Parseo flexible de fecha (reutilizando safe_parse_date para consistencia)
    try:
        fecha_parsed = safe_parse_date(fecha)
        if fecha_parsed.year == 1970:  # Fecha neutra indica parseo fallido
            raise ValueError("Fecha inv√°lida")
    except Exception as e:
        logger.warning(f"Fecha inv√°lida recibida: {fecha} - Error: {e}")
        raise HTTPException(status_code=422, detail=f"Fecha inv√°lida: {fecha}. Usa formato v√°lido (YYYY-MM-DD o similar).")

    # 4. Normalizaci√≥n de patente
    normalized_patente = normalize_patente(patente)
    if not normalized_patente:
        logger.warning(f"Patente inv√°lida: {patente}")
        raise HTTPException(status_code=400, detail="Patente inv√°lida: debe contener caracteres alfanum√©ricos.")

    # === SUBIDA DE COMPROBANTE (opcional) ===
    file_id = None
    if comprobante:
        if comprobante.size > 50 * 1024 * 1024:
            raise HTTPException(status_code=413, detail="Archivo demasiado grande: m√°ximo 50MB.")
        if comprobante.content_type not in ["application/pdf", "image/jpeg", "image/png"]:
            raise HTTPException(status_code=400, detail="Formato no permitido: solo PDF, JPG o PNG.")
        
        bucket = await get_gridfs_bucket()
        file_id = str(await bucket.upload_from_stream(comprobante.filename, await comprobante.read()))
        logger.info(f"Comprobante subido a GridFS: file_id={file_id}")

    # === INSERCI√ìN EN MONGODB ===
    costo_dict = {
        "patente": normalized_patente,
        "tipo_costo": tipo_costo,
        "fecha": fecha_parsed,  # ‚Üê Guardado como datetime (consistente con safe_parse_date)
        "descripcion": descripcion,
        "importe": importe,
        "origen": origen,
        "comprobante_file_id": file_id
    }

    collection = get_db_collection("Mantenimiento" if origen == "Mantenimiento" else "Finanzas")
    result = await collection.insert_one(costo_dict)
    
    logger.info(f"Costo creado exitosamente: _id={result.inserted_id}, file_id={file_id}")

    return CreateCostoResponse(
        message="Costo registrado correctamente",
        costo_id=str(result.inserted_id),
        file_id=file_id
    )

# =================================================================
# ENDPOINT: EDITAR COSTO MANUAL (reemplazo de comprobante si viene nuevo)
# =================================================================

@router.put("/manual/{gasto_id}")
async def editar_gasto_manual(
    gasto_id: str,
    patente: str = Form(...),
    tipo_costo: str = Form(...),
    fecha: str = Form(...),
    descripcion: str = Form(...),
    importe: float = Form(...),
    origen: str = Form(...),
    comprobante: Optional[UploadFile] = File(None)
):
    """
    Edita un gasto manual existente (reemplaza comprobante si se sube nuevo).
    """
    normalized_patente = normalize_patente(patente)

    # Validaciones (igual que en crear)
    if importe <= 0:
        raise HTTPException(422, "Importe debe ser mayor a 0")
    importe = round(importe, 2)

    if not re.match(r"^(Finanzas|Mantenimiento)$", origen):
        raise HTTPException(422, "Origen inv√°lido")

    try:
        fecha_parsed = safe_parse_date(fecha)
    except:
        raise HTTPException(422, "Fecha inv√°lida")

    # Buscar el gasto
    collection = get_db_collection("Mantenimiento" if origen == "Mantenimiento" else "Finanzas")
    gasto_existente = await collection.find_one({"_id": ObjectId(gasto_id)})

    if not gasto_existente:
        raise HTTPException(404, "Gasto no encontrado")

    # Subir nuevo comprobante si viene
    file_id = gasto_existente.get("comprobante_file_id")
    if comprobante:
        bucket = await get_gridfs_bucket()
        file_id = await bucket.upload_from_stream(comprobante.filename, await comprobante.read())

    update_data = {
        "patente": normalized_patente,
        "tipo_costo": tipo_costo,
        "fecha": fecha_parsed,
        "descripcion": descripcion,
        "importe": importe,
        "origen": origen,
        "comprobante_file_id": file_id
    }

    result = await collection.update_one(
        {"_id": ObjectId(gasto_id)},
        {"$set": update_data}
    )

    if result.modified_count == 0:
        raise HTTPException(500, "No se pudo actualizar")

    return {"message": "Gasto actualizado correctamente"}

# ==================== BORRADO UNIVERSAL (CORREGIDO PARA IDs H√çBRIDOS) ====================
@router.delete("/universal/{gasto_id}")
async def borrar_gasto_universal(
    gasto_id: str,
    origen: str = Query(..., description="Colecci√≥n: 'costos' (mantenimiento) o 'finanzas' (multas)")
):
    """
    Elimina un gasto por ID, manejando tanto ObjectId (costos manuales) como strings UUID (cargados v√≠a ETL).
    - Valida origen estrictamente.
    - Loggea intentos y errores para trazabilidad.
    - Normativa: Cumple con idempotencia (si no existe, 404).
    """
    # Normalizaci√≥n y validaci√≥n inicial (mejor pr√°ctica: early return en errores)
    collection_name = origen.lower()
    if collection_name not in ["costos", "finanzas"]:
        logger.warning(f"Origen inv√°lido intentado: {origen}")
        raise HTTPException(400, "Origen inv√°lido: debe ser 'costos' o 'finanzas'")

    collection = get_db_collection("Mantenimiento" if collection_name == "costos" else "Finanzas")
    
    # L√≥gica h√≠brida para _id (try ObjectId primero, fallback a string si falla)
    filter_query = {}
    try:
        obj_id = ObjectId(gasto_id)
        filter_query = {"_id": obj_id}
        logger.info(f"Intentando eliminar como ObjectId: {gasto_id} ({collection_name})")
    except Exception as e:
        filter_query = {"_id": gasto_id}  # Usar directamente como string (UUID u otro)
        logger.info(f"Fallback a string ID (no es ObjectId v√°lido): {gasto_id} ({collection_name}) - Raz√≥n: {e}")
    
    # Ejecuci√≥n as√≠ncrona del delete
    result = await collection.delete_one(filter_query)
    
    if result.deleted_count == 0:
        logger.warning(f"Gasto no encontrado: {gasto_id} en {collection_name}")
        raise HTTPException(404, "Gasto no encontrado")
    
    logger.info(f"Gasto eliminado correctamente: {gasto_id} ({collection_name}) - Fecha: {datetime.now()}")
    return {"message": "Gasto eliminado correctamente"}