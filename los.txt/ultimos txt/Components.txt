// src/components/CostoForm.tsx (TU C√ìDIGO CONFIRMADO)

import { useState } from 'react'; 
import type { FormEvent } from 'react';
import type { NewCostoInput } from '../api/models/vehiculos';
import { createCostoItem } from '../api/vehiculos';
import { normalizePatente } from '../utils/data-utils.ts';

// Propiedades del formulario de Costos
interface CostoFormProps {
    initialPatente?: string; 
    onSuccess: () => void;
}

// Valores iniciales por defecto para el formulario
const defaultFormData: NewCostoInput = {
    patente: '',
    tipo_costo: 'Reparaci√≥n Menor', 
    fecha: new Date().toISOString().split('T')[0], 
    descripcion: '',
    importe: 0,
    origen: 'Mantenimiento', 
};

const CostoForm = ({ initialPatente, onSuccess }: CostoFormProps) => { // üí° SOLUCI√ìN 1: Mueve CostoFormProps al argumento
    const [formData, setFormData] = useState<NewCostoInput>(defaultFormData);
    const [isLoading, setIsLoading] = useState(false);
    const [statusMessage, setStatusMessage] = useState<string | null>(null);

    // ... (Tu l√≥gica de useEffect, tipoCostoOptions, handleChange, handleSubmit y el JSX con estilos)
    // ... (Se asume que el resto del c√≥digo es el que proporcionaste)

    // Aqu√≠ se incluye el JSX de tu formulario que usa gridTemplateColumns: '1fr 1fr' para la adaptabilidad.

    const tipoCostoOptions = [
        'Reparaci√≥n Menor', 'Reparaci√≥n Mayor', 'Neum√°ticos', 'Bater√≠a', 'Service General',
        'Multa', 'Gasto Seguro', 'Impuesto/Patente',
        'Combustible Extra', 'Otros Gastos'
    ];

    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>) => {
        const { name, value, type } = e.target;
        let finalValue: string | number = value;
        if (type === 'number') {
            finalValue = parseFloat(value) || 0;
        }

        setFormData(prev => ({
            ...prev,
            [name]: finalValue
        }));
        
        // L√≥gica de asignaci√≥n autom√°tica de origen
        if (name === 'tipo_costo') {
            const newOrigen = ['Multa', 'Gasto Seguro', 'Impuesto/Patente'].includes(value) ? 'Finanzas' : 'Mantenimiento';
            setFormData(prev => ({ ...prev, origen: newOrigen as 'Finanzas' | 'Mantenimiento' }));
        }
    };

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault();
        
        if (!formData.patente || formData.importe <= 0 || !formData.descripcion) {
            setStatusMessage('Error: Aseg√∫rese de ingresar Patente, Importe (>0) y Descripci√≥n.');
            return;
        }

        setIsLoading(true);
        setStatusMessage(null);

        try {
            const dataToSend: NewCostoInput = {
                ...formData,
                patente: normalizePatente(formData.patente), 
                // Asegurar que la fecha se env√≠e en formato ISO para FastAPI (tu l√≥gica es correcta)
                fecha: new Date(formData.fecha).toISOString(), 
            };
            
            await createCostoItem(dataToSend);
            
            setStatusMessage(`‚úÖ Costo de $${formData.importe.toFixed(2)} registrado con √©xito para ${formData.patente}.`);
            setFormData(initialPatente ? { ...defaultFormData, patente: normalizePatente(initialPatente) } : defaultFormData);
            onSuccess();
            
        } catch (e: unknown) {
            const message = e instanceof Error ? e.message : 'Error desconocido al registrar el costo.';
            setStatusMessage(`‚ùå Error: ${message}`);
        } finally {
            setIsLoading(false);
        }
    };


    return (
        <div style={{ padding: '20px', border: '1px solid #ccc', borderRadius: '8px', background: '#fff' }}>
            <h3 style={{ borderBottom: '1px solid #eee', paddingBottom: '10px', marginBottom: '20px', color: '#1D3557' }}>
                üí∏ Registrar Nuevo Gasto Manual ({formData.origen})
            </h3>
            
            {statusMessage && (
                <p style={{ 
                    padding: '10px', 
                    borderRadius: '5px', 
                    marginBottom: '15px',
                    backgroundColor: statusMessage.startsWith('‚úÖ') ? '#d4edda' : '#f8d7da',
                    color: statusMessage.startsWith('‚úÖ') ? '#155724' : '#721c24',
                    border: `1px solid ${statusMessage.startsWith('‚úÖ') ? '#c3e6cb' : '#f5c6cb'}`
                }}>
                    {statusMessage}
                </p>
            )}

            {/* Este estilo asegura la RESPONSIVIDAD en el formulario */}
            <form onSubmit={handleSubmit} style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', // Auto-ajuste para 2 columnas en desktop, 1 en m√≥vil
                gap: '15px' 
            }}>
                
                {/* 1. Patente */}
                <label style={{ display: 'block' }}>
                    Patente:
                    <input 
                        type="text" 
                        name="patente" 
                        value={formData.patente} 
                        onChange={handleChange} 
                        required 
                        disabled={!!initialPatente} 
                        style={{ padding: '8px', width: '100%', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} 
                    />
                </label>

                {/* 2. Tipo de Costo */}
                <label style={{ display: 'block' }}>
                    Tipo de Gasto:
                    <select 
                        name="tipo_costo" 
                        value={formData.tipo_costo} 
                        onChange={handleChange} 
                        required
                        style={{ padding: '8px', width: '100%', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }}
                    >
                        {tipoCostoOptions.map(option => (
                            <option key={option} value={option}>{option}</option>
                        ))}
                    </select>
                </label>
                
                {/* 3. Fecha */}
                <label style={{ display: 'block' }}>
                    Fecha del Gasto:
                    <input 
                        type="date" 
                        name="fecha" 
                        value={formData.fecha} 
                        onChange={handleChange} 
                        required 
                        style={{ padding: '8px', width: '100%', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} 
                    />
                </label>

                {/* 4. Importe */}
                <label style={{ display: 'block' }}>
                    Importe ($):
                    <input 
                        type="number" 
                        name="importe" 
                        value={formData.importe || ''} 
                        onChange={handleChange} 
                        required 
                        min="0.01"
                        step="0.01"
                        style={{ padding: '8px', width: '100%', border: '1px solid #ccc', borderRadius: '4px', boxSizing: 'border-box' }} 
                    />
                </label>
                
                {/* 5. Descripci√≥n (Ocupa el ancho completo) */}
                <label style={{ display: 'block', gridColumn: '1 / -1' }}> 
                    Descripci√≥n Detallada:
                    <textarea 
                        name="descripcion" 
                        value={formData.descripcion} 
                        onChange={handleChange} 
                        required
                        rows={3}
                        style={{ padding: '8px', width: '99%', border: '1px solid #ccc', borderRadius: '4px', resize: 'vertical', boxSizing: 'border-box' }} 
                    />
                </label>
                
                {/* Bot√≥n de env√≠o (Ocupa el ancho completo) */}
                <button 
                    type="submit" 
                    disabled={isLoading} 
                    style={{ 
                        gridColumn: '1 / -1', 
                        padding: '10px 15px', 
                        marginTop: '15px', 
                        fontWeight: 'bold',
                        backgroundColor: '#E63946', // Rojo corporativo
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer'
                    }}
                >
                    {isLoading ? 'Registrando...' : 'üíæ Guardar Gasto'}
                </button>

            </form>
        </div>
    );
};

export default CostoForm;

// Control_Flota\flota-frontend\src\components\VehiculoForm.tsx

import React, { useState, useEffect } from 'react';
import type { FormEvent } from 'react';
import type { Vehiculo, VehiculoInput, VehiculoUpdateInput } from '../api/models/vehiculos'; 
import { createVehiculo, updateVehiculo } from '../api/vehiculos';

// Propiedades adaptadas para el modo Edici√≥n/Creaci√≥n
interface VehiculoFormProps {
  onSuccess: () => void;
  initialData?: Vehiculo; 
  isEditMode?: boolean;   
}

const defaultFormData: VehiculoInput = { 
    patente: '',
    activo: true,
    anio: null,
    color: null,
    descripcion_modelo: null,
    nro_movil: null,
    tipo_combustible: 'Nafta',
};

const VehiculoForm: React.FC<VehiculoFormProps> = ({ onSuccess, initialData, isEditMode = false }) => {
  const [formData, setFormData] = useState<VehiculoInput>(defaultFormData);
  const [isLoading, setIsLoading] = useState(false);
  const [statusMessage, setStatusMessage] = useState<string | null>(null); 

  useEffect(() => {
    if (isEditMode && initialData) {
        setFormData({
            patente: initialData._id, 
            activo: initialData.activo,
            anio: initialData.anio,
            color: initialData.color,
            descripcion_modelo: initialData.descripcion_modelo,
            nro_movil: initialData.nro_movil,
            tipo_combustible: initialData.tipo_combustible,
        });
    } else {
        setFormData(defaultFormData);
    }
  }, [isEditMode, initialData]); 

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    const newValue = type === 'checkbox' ? (e.target as HTMLInputElement).checked : 
                     type === 'number' ? (value ? parseInt(value) : null) : 
                     (value === '' ? null : value);
    
    setFormData(prev => ({ ...prev, [name]: newValue }));
  };

  // üîë CORRECCI√ìN: Renombramos 'e' a '_e' para silenciar el warning 'no-unused-vars'.
  const handleSubmit = async (_e: FormEvent) => {
    _e.preventDefault(); // Usamos '_e' aqu√≠ para prevenir la recarga.

    setIsLoading(true);
    setStatusMessage(null);
    
    if (!formData.patente || formData.patente.trim() === '') {
        setStatusMessage('Error: La patente es obligatoria.');
        setIsLoading(false);
        return;
    }
    
    const patenteId = formData.patente; 

    try {
        if (isEditMode) {
            // L√≥gica para ACTUALIZAR (PUT)
            
            // Creamos el payload de actualizaci√≥n excluyendo la patente
            const updatePayload: VehiculoUpdateInput = {
                activo: formData.activo,
                anio: formData.anio,
                color: formData.color,
                descripcion_modelo: formData.descripcion_modelo,
                nro_movil: formData.nro_movil,
                tipo_combustible: formData.tipo_combustible,
            };
            
            await updateVehiculo(patenteId, updatePayload); 
            
            setStatusMessage(`‚úÖ Veh√≠culo ${patenteId} actualizado con √©xito.`);
            
        } else {
            // L√≥gica para CREAR (POST)
            await createVehiculo(formData);
            setStatusMessage(`‚úÖ Veh√≠culo ${patenteId} creado con √©xito.`);
            setFormData(defaultFormData); 
        }
        
        onSuccess();

    } catch (error: unknown) {
        const action = isEditMode ? 'actualizar' : 'crear';
        const message = error instanceof Error ? error.message : 'Error desconocido.';
        setStatusMessage(`‚ùå Error al ${action}: ${message}`);
    } finally {
        setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} style={{ padding: '20px', border: '1px solid #ccc', borderRadius: '5px', marginBottom: '20px' }}>
        <h3>{isEditMode ? `Editando Veh√≠culo (${formData.patente})` : 'Crear Nuevo Veh√≠culo'}</h3>
        
        {statusMessage && (
            <p style={{ color: statusMessage.startsWith('‚ùå') ? 'red' : 'green', fontWeight: 'bold' }}>{statusMessage}</p>
        )}
        
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
            <label>
                Patente*:
                <input 
                    type="text" 
                    name="patente" 
                    value={formData.patente} 
                    onChange={handleChange} 
                    required 
                    disabled={isEditMode} 
                    style={{ padding: '5px', width: '90%', backgroundColor: isEditMode ? '#eee' : 'white' }}
                />
            </label>
            <label>
                N√∫mero M√≥vil:
                <input type="text" name="nro_movil" value={formData.nro_movil || ''} onChange={handleChange} style={{ padding: '5px', width: '90%' }} />
            </label>
            <label>
                Modelo/Descripci√≥n:
                <input type="text" name="descripcion_modelo" value={formData.descripcion_modelo || ''} onChange={handleChange} style={{ padding: '5px', width: '90%' }} />
            </label>
            <label>
                A√±o:
                <input type="number" name="anio" value={formData.anio || ''} onChange={handleChange} style={{ padding: '5px', width: '90%' }} />
            </label>
            <label>
                Color:
                <input type="text" name="color" value={formData.color || ''} onChange={handleChange} style={{ padding: '5px', width: '90%' }} />
            </label>
            <label>
                Combustible:
                <select name="tipo_combustible" value={formData.tipo_combustible || ''} onChange={handleChange} style={{ padding: '5px', width: '90%' }}>
                    <option value="Nafta">Nafta</option>
                    <option value="Diesel">Diesel</option>
                    <option value="GNC">GNC</option>
                    <option value="Electrico">El√©ctrico</option>
                </select>
            </label>
            <label style={{ gridColumn: 'span 2' }}>
                Activo:
                <input type="checkbox" name="activo" checked={formData.activo} onChange={handleChange} style={{ margin: '0 10px' }} />
            </label>
        </div>

        <button type="submit" disabled={isLoading} style={{ padding: '8px 15px', marginTop: '15px', fontWeight: 'bold' }}>
            {isLoading ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Crear Veh√≠culo')}
        </button>
    </form>
  );
};

export default VehiculoForm;