from fastapi import FastAPI, HTTPException, status, Query
from dependencies import UpdateMonto, get_db_collection, connect_to_mongodb # Importar funci칩n de conexi칩n
from bson.objectid import ObjectId
from routers import flota 
from typing import List, Optional, Any

# =========================================================================
# 5. INSTANCIA DE FASTAPI Y INCLUSI칍N DE ROUTERS
# =========================================================================

app = FastAPI(
    title="Control de Flota - API",
    description="API de gesti칩n y monitoreo de flota vehicular. Base para una herramienta web/m칩vil.",
    version="1.0.0",
)

# 游릭 EVENTO DE INICIO: FORZAR CONEXI칍N A MONGODB
@app.on_event("startup")
def startup_db_client():
    """Ejecuta la conexi칩n a MongoDB cuando la app inicia."""
    connect_to_mongodb()
    
# Incluir el router de flota
app.include_router(flota.router, prefix="") 

# =========================================================================
# 6. ENDPOINTS GLOBALES (Estado y Modificaci칩n de Monto)
# =========================================================================

@app.get(
    "/",
    tags=["General"], # Etiqueta espec칤fica para este endpoint
    summary="Estado de la API"
)
def read_root():
    """Retorna un mensaje de estado indicando que la API est치 funcionando."""
    return {"status": "ok", "message": "API Control de Flota funcionando correctamente"}

@app.patch(
    "/monto/{collection_name}/{doc_id}",
    response_model=dict,
    summary="Actualizar monto y motivo de un registro (Finanzas/Mantenimiento)",
    tags=["Modificaci칩n de Datos"] # Etiqueta espec칤fica para este endpoint
)
async def update_monto(
    collection_name: str,
    doc_id: str,
    data: UpdateMonto
):
    """
    Permite actualizar el campo 'MONTO' y opcionalmente el campo 'MOTIVO' 
    de un documento espec칤fico en las colecciones 'Finanzas' o 'Mantenimiento'.
    """
    collection_name = collection_name.lower()
    
    if collection_name == 'finanzas':
        collection = get_db_collection("Finanzas")
        monto_field = "monto" # Usamos el campo en min칰scula del modelo
        motivo_field = "motivo" # Usamos el campo en min칰scula del modelo
    elif collection_name == 'mantenimiento':
        collection = get_db_collection("Mantenimiento")
        monto_field = "costo_monto" # Usamos el campo en min칰scula del modelo (mapea a costo_monto)
        motivo_field = "motivo" # Usamos el campo en min칰scula del modelo
    else:
        raise HTTPException(
            status_code=400,
            detail="Colecci칩n no v치lida. Use 'finanzas' o 'mantenimiento'."
        )

    # Convertir el string _id a ObjectId
    try:
        obj_id = ObjectId(doc_id)
    except Exception:
        raise HTTPException(
            status_code=400,
            detail="ID de documento no v치lido. Aseg칰rese de usar un ObjectId v치lido (24 caracteres hexadecimales)."
        )

    # El campo en la DB es 'monto' para Finanzas y 'costo_monto' para Mantenimiento (o el alias en la DB)
    # Aqu칤 estamos usando los nombres de campo de Pydantic, pero necesitamos los nombres de la DB.
    # Dado que los campos en la DB pueden ser inconsistentes (MONTO, costo_monto), 
    # es m치s seguro usar los nombres de campo de la DB directamente si la colecci칩n no es Vehiculos.
    
    db_monto_field = "MONTO" if collection_name == 'finanzas' else "costo_monto"
    db_motivo_field = "motivo" # Asumo que 'motivo' es consistente.

    # Construir el objeto de actualizaci칩n
    update_fields = {db_monto_field: data.monto}
    
    # Si se proporciona un motivo, a침adirlo a la actualizaci칩n
    if data.motivo is not None:
        update_fields[db_motivo_field] = data.motivo
            
    # Ejecutar la actualizaci칩n
    update_result = collection.update_one(
        {"_id": obj_id},
        {"$set": update_fields}
    )

    if update_result.matched_count == 0:
        raise HTTPException(status_code=404, detail=f"Documento no encontrado con ID: {doc_id} en la colecci칩n '{collection_name}'.")
    
    return {"message": f"Monto actualizado con 칠xito en la colecci칩n '{collection_name}' para el ID: {doc_id}", "modified_count": update_result.modified_count}
