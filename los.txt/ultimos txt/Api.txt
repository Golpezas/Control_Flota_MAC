// Control_Flota\flota-frontend\src\api\models\vehiculos.ts

// =================================================================
// ESTRUCTURAS DE VEH√çCULO
// =================================================================

export interface Vehiculo {
  _id: string; // Patente normalizada (usada como ID)
  patente_original?: string; 
  activo: boolean;
  anio: number | null;
  color: string | null; 
  descripcion_modelo: string | null; 
  nro_movil: string | null;
  tipo_combustible: string | null;
}

export interface VehiculoInput { 
  patente: string; // Se necesita para el POST
  activo: boolean;
  anio: number | null;
  color: string | null; 
  descripcion_modelo: string | null;
  nro_movil: string | null;
  tipo_combustible: string | null;
}

// Interfaz necesaria para el PUT (Actualizaci√≥n)
export interface VehiculoUpdateInput {
    activo: boolean;
    anio: number | null;
    color: string | null;
    descripcion_modelo: string | null;
    nro_movil: string | null;
    tipo_combustible: string | null;
}


// =================================================================
// ESTRUCTURAS DE REPORTE Y COSTOS
// =================================================================

/**
 * Define la estructura de un √≠tem de costo/gasto individual.
 */
export interface CostoItem {
    _id: string; // ID del documento en su colecci√≥n original (Crucial)
    tipo: string; // Ej: 'Mantenimiento', 'Infracci√≥n', 'Gasto Seguro'
    fecha: string; // Formato YYYY-MM-DD
    descripcion: string;
    importe: number;
    // Origen crucial para saber de d√≥nde eliminar en el backend
    origen: 'Finanzas' | 'Mantenimiento'; 
    // Usamos unknown para mayor seguridad, pero si lo necesitas, puedes usar 'any'
    metadata_adicional: Record<string, unknown>; 
}

// =================================================================
// üîë INTERFAZ A√ëADIDA: Para CREACI√ìN (Input)
// =================================================================

/**
 * Define la estructura de datos para crear un nuevo costo manual.
 * Se mapea al modelo CostoManualInput de FastAPI.
 */
export interface NewCostoInput { // üîë Aseg√∫rate de que lleva 'export'
    patente: string;
    tipo_costo: string; 
    fecha: string; // Env√≠a como string ISO o YYYY-MM-DD
    descripcion: string;
    importe: number;
    origen: 'Finanzas' | 'Mantenimiento'; 
}

export interface CreateCostoResponse {
    status: 'success' | 'error';
    message: string;
    document_id: string;
}

/**
 * Define la estructura para una alerta de vencimiento (Actualizada).
 * Debe coincidir con el resultado de get_vencimientos_criticos_alertas.
 */
export interface Alerta {
    patente: string; // üîë Agregado
    tipo_documento: string; // üîë Renombrado de 'tipo' a 'tipo_documento'
    fecha_vencimiento: string; // Formato YYYY-MM-DD
    dias_restantes: number;
    mensaje: string; // üîë Agregado
    prioridad: 'CR√çTICA' | 'ALTA' | 'media' | 'baja'; // üîë Valores ajustados a los usados en el backend
    movil_nro?: string; // üîë Agregado
    descripcion_modelo?: string; // üîë Agregado
}

/**
 * Define la estructura de la respuesta completa del reporte para un veh√≠culo.
 */
export interface ReporteCostosResponse {
    patente: string;
    total_general: number;
    // Lista unificada de todos los costos
    costos: CostoItem[]; 
    // Lista de todas las alertas activas
    alertas: Alerta[];
}

/**
 * Define el resumen de costos globales por tipo (para el Dashboard).
 */
export interface ResumenCostoGlobal {
    total_mantenimiento: number;
    total_infracciones: number;
    total_general: number;
}

/**
 * Define la respuesta consolidada para el Dashboard.
 */
export interface DashboardResponse {
    alertas_criticas: Alerta[];
    resumen_costos: ResumenCostoGlobal;
    total_vehiculos: number;
}

// Control_Flota\flota-frontend\src\api\vehiculos.ts

import axios from 'axios';
// Aseg√∫rate de que solo importas, no defines las interfaces aqu√≠.
import type { Vehiculo, VehiculoInput, ReporteCostosResponse, VehiculoUpdateInput, NewCostoInput, CreateCostoResponse, 
    DashboardResponse, } from './models/vehiculos';
import type { Alerta } from './models/vehiculos';

const API_URL = 'http://localhost:8000'; 

const apiClient = axios.create({
    baseURL: API_URL,
    headers: {
        'Content-Type': 'application/json',
    },
});

interface FastAPIErrorResponse {
    detail?: string;
}

/**
 * üóÇÔ∏è Obtiene el listado completo de veh√≠culos. (GET /vehiculos)
 */
export async function fetchVehiculos(): Promise<Vehiculo[]> {
  try {
    console.log(`[LOG:API] Solicitando listado de veh√≠culos.`);
    const response = await apiClient.get<Vehiculo[]>('/vehiculos');
    
    console.log(`[LOG:INFO] Recepci√≥n exitosa de ${response.data.length} veh√≠culos.`);
    return response.data;
  } catch (error: unknown) {
    let errorMessage = 'Error desconocido al listar veh√≠culos.';
    
    // AxiosError se usa aqu√≠ internamente a trav√©s de axios.isAxiosError
    if (axios.isAxiosError(error) && error.response) { 
        const errorData = error.response.data as FastAPIErrorResponse; 
        const detail = errorData.detail || error.message;

        console.error(`[LOG:ERROR] Error ${error.response.status} al listar veh√≠culos:`, detail);
        errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
    } else {
        console.error(`[LOG:CRITICO] Fallo de conexi√≥n o proceso:`, error);
        errorMessage = 'Error de conexi√≥n con el servidor. Verifique que el Backend est√© corriendo.';
    }
    throw new Error(errorMessage);
  }
}

/**
 * ‚ûï Crea un nuevo veh√≠culo. (POST /vehiculos)
 */
export async function createVehiculo(data: VehiculoInput): Promise<Vehiculo> {
  try {
    console.log(`[LOG:API] Creando veh√≠culo con patente: ${data.patente}`);
    const response = await apiClient.post<Vehiculo>('/vehiculos', data);
    
    console.log(`[LOG:INFO] Creaci√≥n exitosa de veh√≠culo: ${response.data._id}`);
    return response.data;
  } catch (error: unknown) {
    let errorMessage = 'Error desconocido al crear veh√≠culo.';
    
    if (axios.isAxiosError(error) && error.response) {
        const errorData = error.response.data as FastAPIErrorResponse;
        const detail = errorData.detail || error.message;

        console.error(`[LOG:ERROR] Fallo en la creaci√≥n de veh√≠culo (${data.patente}):`, detail);
        errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
    }
    throw new Error(`Fallo en la creaci√≥n del veh√≠culo: ${errorMessage}`);
  }
}

/**
 * üóëÔ∏è Elimina un √≠tem de costo/gasto por su ID y origen (Finanzas o Mantenimiento).
 * (DELETE /costos/{origen}/{document_id})
 */
export async function deleteCostoItem(origen: 'Finanzas' | 'Mantenimiento', document_id: string): Promise<void> {
    try {
        console.log(`[LOG:API] Eliminando costo ID ${document_id} de origen: ${origen}`);
        const url = `/costos/${origen}/${document_id}`;
        
        await apiClient.delete(url); // Esperamos 204 No Content
        
        console.log(`[LOG:INFO] Costo eliminado con √©xito: ${document_id}`);
    } catch (error: unknown) {
        let errorMessage = 'Error desconocido al eliminar el costo.';
        if (axios.isAxiosError(error) && error.response) {
            const errorData = error.response.data as FastAPIErrorResponse;
            const detail = errorData.detail || error.message;

            console.error(`[LOG:ERROR] Fallo al eliminar costo (Status: ${error.response.status}):`, detail);
            errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
        }
        throw new Error(errorMessage);
    }
}

/**
 * üóëÔ∏è Elimina un veh√≠culo por su patente normalizada (ID).
 * (DELETE /vehiculos/{patente})
 */
export async function deleteVehiculo(patente: string): Promise<void> {
    try {
        // La patente aqu√≠ ya debe estar normalizada si la API lo requiere, 
        // pero la funci√≥n normalize_patente del backend lo maneja.
        console.log(`[LOG:API] Eliminando veh√≠culo con ID/Patente: ${patente}`);
        const url = `/vehiculos/${patente}`;
        
        // Esperamos 204 No Content
        await apiClient.delete(url); 
        
        console.log(`[LOG:INFO] Veh√≠culo eliminado con √©xito: ${patente}`);
    } catch (error: unknown) {
        let errorMessage = 'Error desconocido al eliminar el veh√≠culo.';
        if (axios.isAxiosError(error) && error.response) {
            const errorData = error.response.data as FastAPIErrorResponse;
            const detail = errorData.detail || error.message;

            console.error(`[LOG:ERROR] Fallo al eliminar veh√≠culo (Status: ${error.response.status}):`, detail);
            errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
        }
        throw new Error(errorMessage);
    }
}

/**
 * ‚úèÔ∏è Actualiza la informaci√≥n de un veh√≠culo. (PUT /vehiculos/{patente})
 */
export async function updateVehiculo(patente: string, data: VehiculoUpdateInput): Promise<Vehiculo> {
    try {
        console.log(`[LOG:API] Actualizando veh√≠culo: ${patente}`);
        const url = `/vehiculos/${patente}`;
        const response = await apiClient.put<Vehiculo>(url, data); 
        console.log(`[LOG:INFO] Actualizaci√≥n exitosa de veh√≠culo: ${patente}.`);
        return response.data;
    } catch (error: unknown) {
        let errorMessage = 'Error desconocido al actualizar veh√≠culo.';
        if (axios.isAxiosError(error) && error.response) {
            const errorData = error.response.data as FastAPIErrorResponse;
            const detail = errorData.detail || (error.message as string);
            errorMessage = `Fallo al actualizar (Status: ${error.response.status}): ${detail}`;
        }
        throw new Error(errorMessage);
    }
}

export async function fetchVehiculoByPatente(patente: string): Promise<Vehiculo> {
    try {
        console.log(`[LOG:API] Solicitando veh√≠culo: ${patente}`);
        const url = `/vehiculos/${patente}`;
        const response = await apiClient.get<Vehiculo>(url);
        
        console.log(`[LOG:INFO] Recepci√≥n exitosa de veh√≠culo: ${response.data._id}.`);
        return response.data;
    } catch (error: unknown) {
        let errorMessage = 'Error desconocido al obtener veh√≠culo.';
        if (axios.isAxiosError(error) && error.response) {
            const errorData = error.response.data as FastAPIErrorResponse;
            const detail = errorData.detail || error.message;

            console.error(`[LOG:ERROR] Error ${error.response.status} al obtener veh√≠culo (${patente}):`, detail);
            errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
        }
        throw new Error(errorMessage);
    }
}

/**
 * üìä Obtiene el reporte de costos (mantenimiento e infracciones) y alertas para un veh√≠culo.
 * (GET /vehiculos/{patente}/reporte)
 */
export async function fetchReporteVehiculo(patente: string): Promise<ReporteCostosResponse> {
    try {
        console.log(`[LOG:API] Solicitando reporte para veh√≠culo: ${patente}`);
        const url = `/vehiculos/${patente}/reporte`;
        // La API devuelve el objeto ReporteCostosResponse
        const response = await apiClient.get<ReporteCostosResponse>(url); 
        
        console.log(`[LOG:INFO] Reporte recibido para veh√≠culo: ${patente}.`);
        return response.data;
    } catch (error: unknown) {
        let errorMessage = 'Error desconocido al obtener el reporte del veh√≠culo.';
        if (axios.isAxiosError(error) && error.response) {
            const errorData = error.response.data as FastAPIErrorResponse;
            const detail = errorData.detail || error.message;

            console.error(`[LOG:ERROR] Fallo al obtener reporte (${patente}):`, detail);
            errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
        }
        throw new Error(errorMessage);
    }
}

/**
 * üìà Obtiene el resumen consolidado de costos y alertas para el Dashboard.
 * (GET /dashboard/resumen)
 */
export async function fetchDashboardData(): Promise<DashboardResponse> {
    try {
        console.log(`[LOG:API] Solicitando datos de Dashboard.`);
        const url = `/dashboard/resumen`;
        
        const response = await apiClient.get<DashboardResponse>(url); 
        
        console.log(`[LOG:INFO] Datos de Dashboard recibidos.`);
        return response.data;
    } catch (error: unknown) {
        // üîë CORRECCI√ìN: Usa 'const' y maneja el error 'e' (o 'error')
        let errorMessage = 'Error desconocido al obtener datos del Dashboard.';
        
        if (axios.isAxiosError(error) && error.response) { 
            const errorData = error.response.data as FastAPIErrorResponse;
            const detail = errorData.detail || (error.message as string);
            
            console.error(`[LOG:ERROR] Fallo al obtener Dashboard (Status: ${error.response.status}):`, detail);
            // üîë CORRECCI√ìN: Si actualizas errorMessage, debes mantener 'let'
            errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
        }
        throw new Error(errorMessage);
    }
}

/**
 * üí∏ Registra un nuevo costo o gasto de forma manual. (POST /costos/crear)
 */
export async function createCostoItem(data: NewCostoInput): Promise<CreateCostoResponse> { // üîë CORREGIDO: Usamos CreateCostoResponse en lugar de any
    try {
        console.log(`[LOG:API] Creando nuevo costo para veh√≠culo: ${data.patente}`);
        const url = `/costos/crear`;
        
        // üîë CORREGIDO: El tipo gen√©rico de post ahora usa CreateCostoResponse
        const response = await apiClient.post<CreateCostoResponse>(url, data); 
        
        console.log(`[LOG:INFO] Costo creado con √©xito: ${response.data.document_id}`);
        return response.data;
    } catch (error: unknown) {
        // ... (el manejo de errores permanece igual)
        let errorMessage = 'Error desconocido al registrar el costo manual.';
        if (axios.isAxiosError(error) && error.response) {
            const errorData = error.response.data as FastAPIErrorResponse;
            const detail = errorData.detail || (error.message as string);
            
            console.error(`[LOG:ERROR] Fallo al crear costo (Status: ${error.response.status}):`, detail);
            errorMessage = `Fallo al crear costo (Status: ${error.response.status}): ${detail}`;
        }
        throw new Error(errorMessage);
    }
}

/**
 * üö® Obtiene todas las alertas cr√≠ticas de documentaci√≥n de la flota.
 * (GET /alertas/criticas)
 */
export async function fetchGlobalAlertas(): Promise<Alerta[]> {
  try {
    console.log(`[LOG:API] Solicitando listado de alertas cr√≠ticas.`);
    const response = await apiClient.get<Alerta[]>('/alertas/criticas');
    
    console.log(`[LOG:INFO] Recepci√≥n exitosa de ${response.data.length} alertas.`);
    return response.data;
  } catch (error: unknown) {
    let errorMessage = 'Error desconocido al listar alertas cr√≠ticas.';
    if (axios.isAxiosError(error) && error.response) {
        const errorData = error.response.data as FastAPIErrorResponse;
        const detail = errorData.detail || error.message;

        console.error(`[LOG:ERROR] Error ${error.response.status} al listar alertas:`, detail);
        errorMessage = `Fallo del servidor (Status: ${error.response.status}): ${detail}`;
    }
    throw new Error(errorMessage);
  }
}